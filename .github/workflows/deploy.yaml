name: CI/CD - Test, Build, Deploy

on:
  push:
    branches:
      - main

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: ${{ secrets.GCP_REGION }}
  REPO_NAME: gpt-runner
  IMAGE_NAME: asia-south1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/gpt-repo/gpt-runner

jobs:
  test-and-build:
    name: ðŸ§ª Test and Build Image
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Set up Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${REGION}-docker.pkg.dev

      - name: Build & Push All Docker Images
        run: |
          echo "ðŸ› ï¸ Building and pushing gpt-runner"
          docker build -t $IMAGE_NAME:latest .
          docker push $IMAGE_NAME:latest

          echo "ðŸ“¦ Building and pushing stock-trader"
          docker build -t asia-south1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/gpt-repo/stock-trader:latest ./stock_trading
          docker push asia-south1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/gpt-repo/stock-trader:latest

          echo "ðŸ“¦ Building and pushing options-trader"
          docker build -t asia-south1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/gpt-repo/options-trader:latest ./options_trading
          docker push asia-south1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/gpt-repo/options-trader:latest

          echo "ðŸ“¦ Building and pushing futures-trader"
          docker build -t asia-south1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/gpt-repo/futures-trader:latest ./futures_trading
          docker push asia-south1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/gpt-repo/futures-trader:latest

  deploy-to-prod:
    name: ðŸš€ Deploy to GKE (if cluster exists)
    needs: test-and-build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Check if GKE cluster exists
        id: check_cluster
        run: |
          if gcloud container clusters describe ${{ secrets.GKE_CLUSTER_NAME }} --region ${{ secrets.GKE_ZONE }} --project ${{ secrets.GCP_PROJECT_ID }} --quiet; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "Cluster not found â€” skipping deploy"
            echo "exists=false" >> $GITHUB_OUTPUT

      - name: Set up kubectl
        if: steps.check_cluster.outputs.exists == 'true'
        uses: google-github-actions/get-gke-credentials@v1
        with:
          cluster_name: ${{ secrets.GKE_CLUSTER_NAME }}
          location: ${{ secrets.GKE_ZONE }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Apply Kubernetes Manifests
        if: steps.check_cluster.outputs.exists == 'true'
        run: |
          kubectl apply -f deployments/

      - name: Restart all trading pods
        if: steps.check_cluster.outputs.exists == 'true'
        run: |
          kubectl rollout restart deployment stock-trader -n gpt
          kubectl rollout restart deployment options-trader -n gpt
          kubectl rollout restart deployment futures-trader -n gpt
          kubectl rollout restart deployment main-runner -n gpt
