deploy-to-prod:
  name: 🚀 Deploy to GKE
  needs: test-and-build
  runs-on: ubuntu-latest

  steps:
    - name: 📥 Checkout repository
      uses: actions/checkout@v3

    - name: 🔐 Authenticate to Google Cloud
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: 🔎 Check if GKE Cluster Exists
      id: check_cluster
      run: |
        if gcloud container clusters describe ${{ secrets.GKE_CLUSTER_NAME }} \
          --region ${{ secrets.GKE_ZONE }} \
          --project ${{ secrets.GCP_PROJECT_ID }} --quiet; then
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "Cluster not found"
          echo "exists=false" >> $GITHUB_OUTPUT
        fi

    - name: ⚙️ Get GKE credentials
      if: ${{ steps.check_cluster.outputs.exists == 'true' }}
      uses: google-github-actions/get-gke-credentials@v1
      with:
        cluster_name: ${{ secrets.GKE_CLUSTER_NAME }}
        location: ${{ secrets.GKE_ZONE }}
        project_id: ${{ secrets.GCP_PROJECT_ID }}

    - name: 🏗️ Create GPT Namespace
      if: ${{ steps.check_cluster.outputs.exists == 'true' }}
      run: kubectl apply -f deployments/namespace.yaml

    - name: 📦 Apply Kubernetes Manifests
      if: ${{ steps.check_cluster.outputs.exists == 'true' }}
      run: kubectl apply -f deployments/

    - name: 🔄 Restart Bot Deployments
      if: ${{ steps.check_cluster.outputs.exists == 'true' }}
      run: |
        kubectl rollout restart deployment stock-trader -n gpt || true
        kubectl rollout restart deployment options-trader -n gpt || true
        kubectl rollout restart deployment futures-trader -n gpt || true
        kubectl rollout restart deployment main-runner -n gpt || true
