name: CI/CD - Test, Build, Deploy

on:
  push:
    branches:
      - main

permissions:
  contents: write
  id-token: write

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: ${{ secrets.GCP_REGION }}
  IMAGE_PREFIX: asia-south1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/gpt-repo

jobs:
  test-and-build:
    name: 🧪 Test & Build & Push Images
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v3

      - name: ⚙️ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: 📦 Install Python dependencies
        run: pip install -r requirements.txt

      - name: 🔐 Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: 🐳 Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      - name: 🧪 Check Docker Availability
        run: docker version

      - name: 🚀 Build & Push All Docker Images
        run: |
          docker build -t $IMAGE_PREFIX/gpt-runner:latest .
          docker push $IMAGE_PREFIX/gpt-runner:latest

          docker build -t $IMAGE_PREFIX/stock-trader:latest ./stock_trading
          docker push $IMAGE_PREFIX/stock-trader:latest

          docker build -t $IMAGE_PREFIX/options-trader:latest ./options_trading
          docker push $IMAGE_PREFIX/options-trader:latest

          docker build -t $IMAGE_PREFIX/futures-trader:latest ./futures_trading
          docker push $IMAGE_PREFIX/futures-trader:latest

  deploy-to-prod:
    name: 🚀 Deploy to GKE
    needs: test-and-build
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v3

      - name: 🔐 Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: 🔎 Check if GKE Cluster Exists
        id: check_cluster
        run: |
          if gcloud container clusters describe ${{ secrets.GKE_CLUSTER_NAME }} \
            --region ${{ secrets.GKE_ZONE }} \
            --project ${{ secrets.GCP_PROJECT_ID }} --quiet; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "Cluster not found"
            echo "exists=false" >> $GITHUB_OUTPUT

      - name: ⚙️ Get GKE credentials
        if: steps.check_cluster.outputs.exists == 'true'
        uses: google-github-actions/get-gke-credentials@v1
        with:
          cluster_name: ${{ secrets.GKE_CLUSTER_NAME }}
          location: ${{ secrets.GKE_ZONE }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: 📦 Apply Kubernetes Manifests
        if: steps.check_cluster.outputs.exists == 'true'
        run: kubectl apply -f deployments/

      - name: 🔄 Restart Bot Deployments
        if: steps.check_cluster.outputs.exists == 'true'
        run: |
          kubectl rollout restart deployment stock-trader -n gpt
          kubectl rollout restart deployment options-trader -n gpt
          kubectl rollout restart deployment futures-trader -n gpt
          kubectl rollout restart deployment main-runner -n gpt